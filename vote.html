<html>
    <head>
        <!-- Bootstrap CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">
        <link href="https://fonts.googleapis.com/css?family=Fredoka+One|Open+Sans&display=swap" rel="stylesheet">

        <title>ChatBlocks Challenge Voting!</title>
        <!-- Global site tag (gtag.js) - Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-135113520-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-135113520-1');
        </script>
      <!-- Required meta tags -->
      <meta charset="utf-8">
      <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
        <script src="https://cdn.jsdelivr.net/npm/comfytwitch@latest/web/comfytwitch.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/comfy.js/dist/comfy.min.js"></script>
        <style>
        html, body {
            font-family: "Fredoka One", "sans-serif";
            color: #ffffff;
            background-color: #333;
        }
        a, a:hover {
            color: #ffa600;
        }
    	.translucent-purple-bg {
    		background-color: rgba( 100, 65, 165, 0.5 );
    		border-color: rgba( 100, 65, 165, 0.5 );
    		color: #ccc;
    	}
        .btn-purple-outline {
            background-color: #fff;
            border-color: #fff;
            color: #6441a5;
        }
        .btn-purple {
            background-color: #6441a5;
            border-color: #6441a5;
            color: #fff;
        }
        .btn-primary {
            background-color: #4C97FF;
            border-color: #4C97FF;
        }
        .btn-warning {
            background-color: #ffa600;
            border-color: #ffa600;
        }
        .card {
            background-color: #6441a5;
            color: #fff;
        }
        .card-img-top {
            width: 100%;
            height: 25vw;
            object-fit: cover;
        }
        .pre {
            white-space: pre-wrap;
        }
        </style>
    </head>
    <body class="container">
        <div id="login-group" class="py-2 float-right" hidden><button id="login" class="btn btn-purple center">Log In with <i class="fa fa-twitch"></i> Twitch</button></div><div id="profile-group" class="py-2 float-right" hidden><span><span id="username"></span> <img id="profile-image" class="rounded" src="" alt="Profile Image" height="38" width="38"></span> <button id="logout" class="btn btn-purple">Log Out</button></div>
        <h1>ChatBlocks by <a href="https://www.instafluff.tv" target="_blank">Instafluff</a></h1>
        <p>Vote for your favorite ChatBlocks challenge entry! <span class="text-info">(Until Fri Oct 30, 11:59pm Pacific Time)</span></p>
        <div id="entries" class="row">
        </div>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
        <script>
            const params = new URLSearchParams( location.search );
            let submissions = [
                {
                    "creator": "KimballDonald",
                    "description": `A simple command that sends users on a quest! Generates a location and an action randomly.`,
                    "notes": `Thank you Instafluff for making such a neat tool!`,
                    "screenshots": [ "1_quest_01.png" ],
                    "file": "1_quest.cbs"
                },
                {
                    "creator": "walpolea",
                    "description": `I created a math chat game to test out your knowledge of expression evaluation. With the !mathlete command, chat is given an expression and can guess answers with !math [answer]. But hurry up, because you only have a limited amount of time to answer!`,
                    "notes": ``,
                    "screenshots": [ "2_mathlete_01.png", "2_mathlete_02.png" ],
                    "file": "2_mathlete.cbs"
                },
                {
                    "creator": "KimballDonald",
                    "description": `I recreated the Wind Waker Squid Hunt minigame! I manually set the locations which contain empty squares and which contains octoroks, and then whoever redeems the command gets to use 24 cannonballs to try to hit!`,
                    "notes": ``,
                    "screenshots": [ "3_windwaker_01.png" ],
                    "file": "3_windwaker.cbs"
                },
                {
                    "creator": "sparky_pugwash",
                    "description": `Cleaning tips`,
                    "notes": `Cleaning tips bot !clean`,
                    "screenshots": [ "4_cleanbot_01.jpg", "4_cleanbot_02.jpg" ],
                    "file": "4_cleanbot.cbs"
                },
                {
                    "creator": "Gilokk0",
                    "description": `"This is a chatbot that uses Fun Translations API (https://funtranslations.com/api/) to translate to Klingon, Leetspeak, Minion, Morse, Pirate, Vulcan and Zoda (from English). It also translates from Morse to English.

The translation API has a ratelimit. Fun Translations has this on the API page: ""Our translation API is public. To maintain our service level we ratelimit the number of API calls. For public API calls this is 60 API calls a day with distribution of 5 calls an hour. For paid plans this limit is increased according to the service level described in the plan.""

This chatbot also has a shoutout command (named shout), to shoutout other streamers during stream (or to shoutout themselves, if chatmessage is empty)."`,
                    "notes": `Hope you all enjoy it! ;D`,
                    "screenshots": [ "5_funtranslations_01.png" ],
                    "file": "5_funtranslations.cbs"
                },
                {
                    "creator": "ellenary",
                    "description": `A numeric counter for when you want to keep track of a number of things. This is just the base counter, but the possibilities are limitless! You can put several counters as different keys in the same bin, use if/else statements so you can choose if only mods or subscribers can use the command and you can even set multiple commands to point to the same counter! ChatBlocks is amazing!!`,
                    "notes": `Figuring out permanent storage has opened a whole new world to me. Thank you so much to Schublo for inspiring this counter and helping test it, InformaTheMusic for helping me get this working, and to EveryDayGamerM for letting me use her stream as a guinea pig!`,
                    "screenshots": [ "6_counter_01.png", "6_counter_02.png" ],
                    "file": "6_counter.cbs"
                },
                {
                    "creator": "wabes1",
                    "description": `Fishing Stream !commands: count the fish in chat, with TTS alerts. Plus more !`,
                    "notes": `"My Chat-block was made for the streamer who does live Fishing.
!commands count the fish in chat.

Anyone in chat can type:
            wow - gg - fishon - fishoff       (All TTS Alerts)

Any Mod & Sub only can type:
             !fish+   (TTS, Add # to counter) (and if two mod, both key in, next line down)
             !fish-    (TTS, Subtract # to counter) (So total # can go up and down)
             !fish     (TTS, Total # at anytime) (so if someone shows up late, they can get-
                          a update count)


  Any Mod only can type:
             !fishreset     (TTS, Puts counter back to zero)
             !123drink     (TTS, A slow count down for a drink up) "`,
                    "screenshots": [ "7_fishing_01.png" ],
                    "file": "7_fishing.cbs"
                },
                {
                    "creator": "Caffidget",
                    "description": `text-to-speech for any events so I can hear when things happen`,
                    "notes": `I love ChatBlocks - still new and figuring things out so this is rudimentary.`,
                    "screenshots": [ "8_eventtts_01.png" ],
                    "file": "8_eventtts.cbs"
                },
                {
                    "creator": "informathemusic",
                    "description": `Tell me the odds of winning for the chatblocks!`,
                    "notes": ``,
                    "screenshots": [ "9_cbwinodds_01.png" ],
                    "file": "9_cbwinodds.cbs"
                },
            ];

            (async () => {
                let votes = await fetch( "https://api.instafluff.tv:9999/cbvotes/2" ).then( r => r.json() ).catch( err => {} );
                votes = votes || {};
                let entries = [];
                submissions.forEach( ( entry, i ) => {
                    console.log( entry, i );
                    let carouselIndicators = "";
                    let carouselItems = "";
                    entry.screenshots.forEach( ( s, n ) => {
                        carouselIndicators += `<li data-target="#carousel_${i}" data-slide-to="${n}" ${n === 0 ? 'class="active"' : ''}></li>`;
                        carouselItems += `<div class="carousel-item ${n === 0 ? "active" : ""}"><img src="web/vote2/${s}" class="d-block w-100 card-img-top" alt="screenshot"></div>`
                    });
                    entries.push(`
                        <div class="col-4 pb-4">
                        <div class="card">
                          <div id="carousel_${i}" class="carousel slide" data-ride="carousel">
                            <ol class="carousel-indicators">
                              ${carouselIndicators}
                            </ol>
                            <div class="carousel-inner">
                              ${carouselItems}
                            </div>
                            <a class="carousel-control-prev" href="#carousel_${i}" role="button" data-slide="prev">
                              <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                              <span class="sr-only">Previous</span>
                            </a>
                            <a class="carousel-control-next" href="#carousel_${i}" role="button" data-slide="next">
                              <span class="carousel-control-next-icon" aria-hidden="true"></span>
                              <span class="sr-only">Next</span>
                            </a>
                          </div>
                          <div class="card-body">
                            <h5 class="card-title">Built By: <span class="text-warning">${entry.creator}</span></h5>
                            <a href="web/vote2/${entry.file}" target="_blank" class="btn btn-info" download>Download</a>
                            <button id="vote_${i}" class="btn btn-danger" onclick="sendVote(${i})">Votes (${( votes[ i ] || 0 ) + 1})</button>
                            <br/><br/>
                            <p class="card-text pre"><small>${entry.description}</small></p>
                            <br/><br/>
                            <small><i>${entry.notes}</i></small>
                          </div>
                        </div>
                        </div>`);
                });
                // Shuffle entries
                for( let i = entries.length - 1; i > 0; i-- ) {
                    const j = Math.floor( Math.random() * ( i + 1 ) );
                    [ entries[ i ], entries[ j ] ] = [ entries[ j ], entries[ i ] ];
                }
                entries.forEach( e => {
                    $( "#entries" ).append( e );
                });
            })();

            async function sendVote( id ) {
                let result = await fetch( `https://api.instafluff.tv:9999/cbvote/2?twitch=${ComfyTwitch.Token}&vote=${id}` );
                // console.log( "VOTE", result );
                location.reload();
            }

            const clientId = "xrxinjwucvs83rf1b6lxq758yslj3c";
            const baseUrl = window.location.origin + window.location.pathname;

            ComfyTwitch.Check()
            .then( async result => {
                console.log( result );
                if( result ) {
                    // Logged In
                    let user = await ComfyTwitch.GetUser( clientId, result.user_id );
                    document.getElementById( "username" ).innerText = user.display_name;
                    document.getElementById( "profile-image" ).src = user.profile_image_url;
                    document.querySelector( "#login-group" ).setAttribute( "hidden", true );
    				document.querySelector( "#profile-group" ).removeAttribute( "hidden" );
                    document.querySelector( "#logout" ).addEventListener( "click", function() {
                        ComfyTwitch.Logout();
                        window.location.reload();
                    });

                    let myVote = await fetch( `https://api.instafluff.tv:9999/cbmyvote/2?twitch=${ComfyTwitch.Token}` ).then( r => r.json() ).catch( err => {} );
                    console.log( myVote );
                    if( myVote && myVote.user ) {
                        $( `#vote_${myVote.vote}` ).text( $( `#vote_${myVote.vote}` ).text().replace( "Votes", "My Vote" ) );
                        $( `#vote_${myVote.vote}` ).removeClass( "btn-danger" );
                        $( `#vote_${myVote.vote}` ).addClass( "btn-secondary" );
                    }
                }
                else {
                    // Logged Out
                    document.querySelector( "#profile-group" ).setAttribute( "hidden", true );
                    document.querySelector( "#login-group" ).removeAttribute( "hidden" );
                    document.querySelector( "#login" ).addEventListener( "click", function() {
                        ComfyTwitch.Login( clientId, baseUrl, [ "user:read:email" ] );
                    });
                }
            });
        </script>
    </body>
</html>
